#!/bin/sh

. /lib/dracut-zfs-lib.sh

case "${root}" in
	zfs:*) ;;
	*) return ;;
esac

# 'rootmnt' is used in mount_fs() to figure out where to
# mount the filesystem.
[ -n "$NEWROOT" ] && rootmnt=${NEWROOT}

# Delay until all required block devices are present.
udev_trigger

if [ "${root}" = "zfs:AUTO" ] ; then
	ZFS_BOOTFS=""
	POOLS=$(get_pools)
	IFS=";"
	for pool in $POOLS
	do
		[ -z "$pool" ] && continue

		# No 'else' or return below - if there's more pools, we try
		# them. If not, we'll drop through and go to the end
		# where we need a reboot because we couldn't find a root fs.
		if import_pool "$pool"; then
			if find_rootfs "$pool"; then
				if mount_fs "${ZFS_BOOTFS}"; then
					info "ZFS: Using ${ZFS_BOOTFS} as root."

					rootok=1
					IFS="$OLD_IFS"

					return 0
				fi
			fi
		fi
	done
fi

rootok=0
need_shutdown
